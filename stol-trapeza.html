<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Стол “Трапеза” — AluLuxe</title>
  <meta name="description" content="Большой обеденный стол ‘Трапеза’ из алюминия для семейных ужинов на террасе. Надежная и стильная мебель от AluLuxe." />
  <link rel="stylesheet" href="style.css" />
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
</head>
<body>

  <div id="header-container"></div>

  <main>
    <section class="breadcrumbs">
      <a href="index.html">Главная</a> <span>&rsaquo;</span>
      <a href="index.html#catalog">Каталог</a> <span>&rsaquo;</span>
      <span>Стол “Трапеза”</span>
    </section>

    <section class="product-detail-section section">
      <div class="product-gallery" data-aos="fade-right">
        <div class="main-image">
          <img id="current-image" src="img/4.jpg" alt="Стол Трапеза" onclick="openLightbox(currentIndex)" />
        </div>
        <div class="thumbnail-gallery">
          <img class="thumb active" src="img/4.jpg"    data-index="0" alt="Трапеза 1" />
          <img class="thumb"        src="img/4-1.jpg" data-index="1" alt="Трапеза 2" />
          <img class="thumb"        src="img/4-2.jpg" data-index="2" alt="Трапеза 3" />
          <img class="thumb"        src="img/4-3.jpg" data-index="3" alt="Трапеза 4" />
        </div>
      </div>

      <div class="product-info-details" data-aos="fade-left">
        <h1 class="product-title-page">Стол “Трапеза”</h1>
        <p class="product-short-description">Прочный обеденный стол из алюминия, идеально подходящий для семейных ужинов на свежем воздухе.</p>
        <p class="product-price-page">44&nbsp;550&nbsp;руб.</p>

        <!-- === Блок выбора цвета по RAL === -->
        <div class="product-color-options">
          <h4>Выберите цвет каркаса</h4>
          <div class="color-picker">
            <div class="color-option selected" data-color="9016" data-color-name="Белый транспортный" style="background-color: #F6F6F6; border: 1px solid #ddd;">
              <span class="color-label">RAL 9016</span>
            </div>
            <div class="color-option" data-color="7035" data-color-name="Серый светлый" style="background-color: #D7D7D7;">
              <span class="color-label">RAL 7035</span>
            </div>
            <div class="color-option" data-color="6005" data-color-name="Зелёный мох" style="background-color: #2F4F2F;">
              <span class="color-label">RAL 6005</span>
            </div>
            <div class="color-option" data-color="5012" data-color-name="Синий светлый" style="background-color: #3E5F8A;">
              <span class="color-label">RAL 5012</span>
            </div>
            <div class="color-option" data-color="3000" data-color-name="Красный огненный" style="background-color: #AF2B1E;">
              <span class="color-label">RAL 3000</span>
            </div>
            <div class="color-option custom" data-color="custom" data-color-name="Другой цвет">
              <span class="color-label">На заказ</span>
            </div>
          </div>
          <p class="color-note">Выбранный цвет: <strong id="selected-color-name">Белый транспортный (RAL 9016)</strong></p>
        </div>

        <div class="product-order-button">
          <button class="btn btn-primary btn-tocart"
                  data-product-id="prod004"
                  data-product-name="Стол Трапеза"
                  data-product-price="44550"
                  data-product-image="img/4.jpg"
                  data-product-color="9016">
            Добавить в корзину
          </button>
        </div>

        <div class="product-full-description">
          <h4>Описание товара</h4>
          <p>Стол “Трапеза” выполнен из алюминиевого сплава толщиной 2 мм, устойчив к коррозии и погодным условиям. Легко очищается и сохраняет вид на многие годы.</p>
        </div>

        <div class="product-characteristics">
          <h4>Характеристики</h4>
          <ul>
            <li><strong>Каркас:</strong><span>Алюминий 2 мм</span></li>
            <li><strong>Столешница:</strong><span>Композитный материал</span></li>
            <li><strong>Габариты (Д×Ш×В):</strong><span>130×73×66 см</span></li>
            <li><strong>Упаковка (Д×Ш×В):</strong><span>1×1×1 см</span></li>
            <li><strong>Цвет:</strong><span>По каталогу RAL</span></li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <div id="footer-container"></div>

  <!-- Lightbox -->
  <div class="lightbox-overlay" onclick="closeLightbox()">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <img class="lightbox-image" src="" alt="Фото товара" />
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="global.js"></script>
  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
  <script src="cart.js"></script>
  <script>
    let images = ['img/4.jpg','img/4-1.jpg','img/4-2.jpg','img/4-3.jpg'];
    let currentIndex = 0;

    async function filterImages() {
      const checks = await Promise.all(images.map(src =>
        new Promise(res => {
          const img = new Image();
          img.onload  = () => res(true);
          img.onerror = () => res(false);
          img.src = src;
        })
      ));
      images = images.filter((_, i) => checks[i]);
      document.querySelectorAll('.thumbnail-gallery .thumb').forEach(thumb => {
        const idx = +thumb.dataset.index;
        if (idx >= images.length) thumb.remove();
      });
      document.querySelectorAll('.thumbnail-gallery .thumb').forEach((thumb, i) => {
        thumb.dataset.index = i;
        thumb.src = images[i];
        thumb.classList.toggle('active', i === 0);
      });
    }

    function updateMain() {
      document.getElementById('current-image').src = images[currentIndex];
      document.querySelectorAll('.thumbnail-gallery .thumb').forEach((t,i) =>
        t.classList.toggle('active', i === currentIndex)
      );
    }

    function openLightbox(idx) {
      currentIndex = idx;
      document.querySelector('.lightbox-image').src = images[currentIndex];
      document.querySelector('.lightbox-overlay').style.display = 'flex';
      document.body.classList.add('lightbox-open');
    }
    function closeLightbox() {
      document.querySelector('.lightbox-overlay').style.display = 'none';
      document.body.classList.remove('lightbox-open');
    }
    function navigateLightbox(dir) {
      currentIndex = (currentIndex + dir + images.length) % images.length;
      document.querySelector('.lightbox-image').src = images[currentIndex];
      updateMain();
    }

    // === Обработчик выбора цвета по RAL ===
    function initColorPicker() {
      const colorOptions = document.querySelectorAll('.color-option');
      const addToCartBtn = document.querySelector('.btn-tocart');
      const selectedColorName = document.getElementById('selected-color-name');

      if (colorOptions.length && addToCartBtn) {
        const defaultColorOption = colorOptions[0];
        const initialColor = defaultColorOption.getAttribute('data-color');
        const initialColorName = defaultColorOption.getAttribute('data-color-name');
        addToCartBtn.setAttribute('data-product-color', initialColor);
        selectedColorName.textContent = `${initialColorName} (RAL ${initialColor})`;

        colorOptions.forEach(option => {
          option.addEventListener('click', function () {
            colorOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            const selectedColor = this.getAttribute('data-color');
            const selectedName = this.getAttribute('data-color-name');
            addToCartBtn.setAttribute('data-product-color', selectedColor);
            if (selectedColor === 'custom') {
              selectedColorName.textContent = 'Другой цвет (на заказ)';
            } else {
              selectedColorName.textContent = `${selectedName} (RAL ${selectedColor})`;
            }
          });
        });
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await filterImages();
      updateMain();
      initColorPicker(); // Инициализируем выбор цвета
      
      document.querySelectorAll('.thumbnail-gallery .thumb').forEach(thumb =>
        thumb.addEventListener('click', () => { currentIndex = +thumb.dataset.index; updateMain(); })
      );
      document.addEventListener('keydown', e => {
        if (document.querySelector('.lightbox-overlay').style.display !== 'flex') return;
        if (e.key==='ArrowRight') navigateLightbox(1);
        if (e.key==='ArrowLeft')  navigateLightbox(-1);
        if (e.key==='Escape')     closeLightbox();
      });
      let startX=0, ov=document.querySelector('.lightbox-overlay');
      ov.addEventListener('touchstart', e=>startX=e.touches[0].clientX);
      ov.addEventListener('touchend', e=>{ const dx=e.changedTouches[0].clientX-startX; if(dx>50) navigateLightbox(-1); if(dx<-50) navigateLightbox(1); });
    });

    (async function(){
      const h = await fetch('header.html').then(r=>r.text());
      document.getElementById('header-container').innerHTML = h;
      if(window.initHeader) window.initHeader();
      if(window.updateCartIcon) window.updateCartIcon();
      const f = await fetch('footer.html').then(r=>r.text());
      document.getElementById('footer-container').innerHTML = f;
      AOS.init({duration:800,offset:100,once:true,disable:'mobile'});
    })();
  </script>
</body>
</html>
